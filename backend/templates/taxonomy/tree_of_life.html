{% extends "base.html" %}

{% block title %}Tree of Life - Taxonomy Visualization{% endblock %}

{% block extra_css %}
<style>
  .node circle {
    fill: #fff;
    stroke: steelblue;
    stroke-width: 1.5px;
  }

  .node text {
    font: 12px sans-serif;
    fill: #333;
  }

  .link {
    fill: none;
    stroke: #ccc;
    stroke-width: 1.5px;
  }

  .tooltip {
    position: absolute;
    padding: 8px;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #ddd;
    border-radius: 4px;
    pointer-events: none;
    font-size: 12px;
    max-width: 300px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .tooltip h4 {
    margin: 0 0 5px 0;
    font-size: 14px;
  }

  .tooltip p {
    margin: 2px 0;
  }

  .controls {
    margin-bottom: 20px;
  }

  .controls button {
    margin-right: 10px;
    padding: 8px 16px;
    background-color: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
  }

  .controls button:hover {
    background-color: #f1f1f1;
  }

  #status {
    margin-top: 10px;
    color: #666;
    font-style: italic;
  }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="row">
    <div class="col-12">
      <h1 class="mb-4">Tree of Life Visualization</h1>

      <div class="controls">
        <button id="zoomIn">Zoom In</button>
        <button id="zoomOut">Zoom Out</button>
        <button id="resetZoom">Reset View</button>

        <div class="form-check form-switch ms-3 d-inline-block">
          <input class="form-check-input" type="checkbox" id="showLabels" checked>
          <label class="form-check-label" for="showLabels">Show Labels</label>
        </div>
      </div>

      <div id="status">Loading taxonomy data...</div>

      <div id="visualization" style="width: 100%; height: 800px; border: 1px solid #eee; overflow: hidden;"></div>

      <div class="row mt-4">
        <div class="col-md-3">
          <div class="card">
            <div class="card-body text-center">
              <h5 class="card-title">Families</h5>
              <p class="card-text" id="familyCount">-</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body text-center">
              <h5 class="card-title">Genera</h5>
              <p class="card-text" id="genusCount">-</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body text-center">
              <h5 class="card-title">Species</h5>
              <p class="card-text" id="speciesCount">-</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body text-center">
              <h5 class="card-title">Largest Family</h5>
              <p class="card-text" id="largestFamily">-</p>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <h4>Legend</h4>
        <div class="d-flex flex-wrap">
          <div class="me-4 mb-2">
            <span style="display: inline-block; width: 12px; height: 12px; background-color: #4682B4; border-radius: 50%; margin-right: 5px;"></span> Family
          </div>
          <div class="me-4 mb-2">
            <span style="display: inline-block; width: 12px; height: 12px; background-color: #5F9EA0; border-radius: 50%; margin-right: 5px;"></span> Genus
          </div>
          <div class="me-4 mb-2">
            <span style="display: inline-block; width: 12px; height: 12px; background-color: #82B446; border-radius: 50%; margin-right: 5px;"></span> Tree
          </div>
          <div class="me-4 mb-2">
            <span style="display: inline-block; width: 12px; height: 12px; background-color: #B4824A; border-radius: 50%; margin-right: 5px;"></span> Palm Tree
          </div>
          <div class="me-4 mb-2">
            <span style="display: inline-block; width: 12px; height: 12px; background-color: #746EB3; border-radius: 50%; margin-right: 5px;"></span> Shrub
          </div>
          <div class="me-4 mb-2">
            <span style="display: inline-block; width: 12px; height: 12px; background-color: #999; border-radius: 50%; margin-right: 5px;"></span> Other
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // DOM elements
  const visualizationContainer = document.getElementById('visualization');
  const statusElement = document.getElementById('status');
  const zoomInButton = document.getElementById('zoomIn');
  const zoomOutButton = document.getElementById('zoomOut');
  const resetZoomButton = document.getElementById('resetZoom');
  const showLabelsCheckbox = document.getElementById('showLabels');

  // Count elements
  const familyCountElement = document.getElementById('familyCount');
  const genusCountElement = document.getElementById('genusCount');
  const speciesCountElement = document.getElementById('speciesCount');
  const largestFamilyElement = document.getElementById('largestFamily');

  // Initialize variables
  let svg;
  let g;
  let zoom;
  let hierarchyData;
  let treeLayout;
  let root;

  // Create tooltip
  const tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

  // Set dimensions
  const margin = {top: 40, right: 120, bottom: 40, left: 120};
  const width = visualizationContainer.clientWidth - margin.left - margin.right;
  const height = visualizationContainer.clientHeight - margin.top - margin.bottom;

  // Initialize SVG
  function initializeSvg() {
    // Create SVG
    svg = d3.select(visualizationContainer)
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom);

    // Create a group for the tree
    g = svg.append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    // Set up zoom behavior
    zoom = d3.zoom()
      .scaleExtent([0.1, 8])
      .on("zoom", (event) => {
        g.attr("transform", event.transform);
      });

    svg.call(zoom);
  }

  // Fetch taxonomy data
  function fetchData() {
    statusElement.textContent = "Loading taxonomy data...";

    fetch('/api/v1/taxonomy/families/hierarchy/')
      .then(response => {
        if (!response.ok) {
          throw new Error(`API request failed with status ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log("Taxonomy data loaded successfully");
        hierarchyData = data;
        updateStatistics();
        drawTree();
        statusElement.textContent = "Taxonomy data loaded successfully";
      })
      .catch(error => {
        console.error("Error fetching taxonomy data:", error);
        statusElement.textContent = `Error loading data: ${error.message}`;
      });
  }

  // Update statistics
  function updateStatistics() {
    if (!hierarchyData) return;

    // Count families
    const familyCount = hierarchyData.children?.length || 0;
    familyCountElement.textContent = familyCount;

    // Count genera
    let genusCount = 0;
    let speciesCount = 0;
    let largestFamily = '';
    let maxGenera = 0;

    hierarchyData.children?.forEach(family => {
      const genusCountForFamily = family.children?.length || 0;
      genusCount += genusCountForFamily;

      // Find largest family
      if (genusCountForFamily > maxGenera) {
        maxGenera = genusCountForFamily;
        largestFamily = family.name;
      }

      // Count species
      family.children?.forEach(genus => {
        speciesCount += genus.children?.length || 0;
      });
    });

    genusCountElement.textContent = genusCount;
    speciesCountElement.textContent = speciesCount;
    largestFamilyElement.textContent = largestFamily || 'None';
  }

  // Draw tree
  function drawTree() {
    if (!hierarchyData || !svg || !g) return;

    // Clear existing content
    g.selectAll("*").remove();

    // Create tree layout
    treeLayout = d3.tree()
      .size([height, width - 200]);

    // Create hierarchy
    root = d3.hierarchy(hierarchyData);

    // Apply tree layout
    treeLayout(root);

    // Add links
    g.selectAll(".link")
      .data(root.links())
      .enter()
      .append("path")
      .attr("class", "link")
      .attr("d", d => {
        return `M${d.target.y},${d.target.x}
                C${(d.target.y + d.source.y) / 2},${d.target.x}
                 ${(d.target.y + d.source.y) / 2},${d.source.x}
                 ${d.source.y},${d.source.x}`;
      });

    // Add nodes
    const nodes = g.selectAll(".node")
      .data(root.descendants())
      .enter()
      .append("g")
      .attr("class", "node")
      .attr("transform", d => `translate(${d.y},${d.x})`)
      .on("mouseover", function(event, d) {
        tooltip.transition()
          .duration(200)
          .style("opacity", 0.9);

        let tooltipHtml = `<h4>${d.data.name}</h4>`;

        if (d.data.type === "species") {
          tooltipHtml += `<p><strong>Scientific Name:</strong> ${d.data.scientific_name || d.data.name}</p>`;
          if (d.data.life_form) tooltipHtml += `<p><strong>Life Form:</strong> ${d.data.life_form}</p>`;
          if (d.data.origin) tooltipHtml += `<p><strong>Origin:</strong> ${d.data.origin}</p>`;
          if (d.data.iucn_status) tooltipHtml += `<p><strong>IUCN Status:</strong> ${d.data.iucn_status}</p>`;
        } else {
          tooltipHtml += `<p><strong>Type:</strong> ${d.data.type}</p>`;
          tooltipHtml += `<p><strong>Children:</strong> ${d.children ? d.children.length : 0}</p>`;
        }

        tooltip.html(tooltipHtml)
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 28) + "px");
      })
      .on("mouseout", function() {
        tooltip.transition()
          .duration(500)
          .style("opacity", 0);
      });

    // Add circles to nodes
    nodes.append("circle")
      .attr("r", d => getNodeRadius(d))
      .style("fill", d => getNodeColor(d))
      .style("stroke", d => d3.rgb(getNodeColor(d)).darker(0.5));

    // Add labels to nodes
    nodes.append("text")
      .attr("dy", ".35em")
      .attr("x", d => d.children ? -10 : 10)
      .style("text-anchor", d => d.children ? "end" : "start")
      .style("font-size", d => getNodeFontSize(d))
      .text(d => d.data.name)
      .style("opacity", showLabelsCheckbox.checked ? 1 : 0);

    // Center the view
    resetView();
  }

  // Helper functions
  function getNodeRadius(d) {
    switch(d.data.type) {
      case 'family': return 8;
      case 'genus': return 6;
      default: return 4; // species
    }
  }

  function getNodeFontSize(d) {
    switch(d.data.type) {
      case 'family': return '14px';
      case 'genus': return '12px';
      default: return '10px'; // species
    }
  }

  function getNodeColor(d) {
    switch(d.data.type) {
      case 'family': return '#4682B4'; // Steel Blue
      case 'genus': return '#5F9EA0'; // Cadet Blue
      default: {
        // For species, color based on life form if available
        const lifeForm = d.data.life_form?.toLowerCase() || '';
        if (lifeForm.includes('tree')) return '#82B446'; // Green
        if (lifeForm.includes('palm')) return '#B4824A'; // Brown
        if (lifeForm.includes('shrub')) return '#746EB3'; // Purple
        return '#999'; // Default gray
      }
    }
  }

  // Control functions
  function zoomIn() {
    svg.transition().duration(300).call(
      zoom.scaleBy, 1.3
    );
  }

  function zoomOut() {
    svg.transition().duration(300).call(
      zoom.scaleBy, 0.7
    );
  }

  function resetView() {
    svg.transition().duration(500).call(
      zoom.transform,
      d3.zoomIdentity.translate(margin.left, margin.top).scale(1)
    );
  }

  function toggleLabels() {
    const showLabels = showLabelsCheckbox.checked;
    g.selectAll(".node text").style("opacity", showLabels ? 1 : 0);
  }

  // Set up event listeners
  zoomInButton.addEventListener('click', zoomIn);
  zoomOutButton.addEventListener('click', zoomOut);
  resetZoomButton.addEventListener('click', resetView);
  showLabelsCheckbox.addEventListener('change', toggleLabels);

  // Initialize visualization
  initializeSvg();
  fetchData();

  // Handle window resize
  window.addEventListener('resize', function() {
    // Resize SVG to fit container
    svg.attr("width", visualizationContainer.clientWidth);
    svg.attr("height", visualizationContainer.clientHeight);
  });
});
</script>
{% endblock %}
