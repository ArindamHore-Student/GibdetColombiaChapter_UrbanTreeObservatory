<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radial Tree of Life</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        .node circle {
            fill: #fff;
            stroke-width: 1.5px;
        }

        .node text {
            font: 10px sans-serif;
            fill: #333;
        }

        .node--internal text {
            text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }

        .tooltip {
            position: absolute;
            padding: 8px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            pointer-events: none;
            font-size: 12px;
            max-width: 300px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tooltip h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
        }

        .tooltip p {
            margin: 2px 0;
        }

        .controls {
            margin-bottom: 20px;
        }

        .controls button {
            margin-right: 10px;
            padding: 8px 16px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .controls button:hover {
            background-color: #f1f1f1;
        }

        #status {
            margin-top: 10px;
            color: #666;
            font-style: italic;
        }

        #visualization {
            width: 100%;
            height: 800px;
            border: 1px solid #eee;
            overflow: hidden;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: bold;
        }

        .card-text {
            font-size: 20px;
            font-weight: bold;
        }

        .stats-container {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
            margin-top: 20px;
        }

        .stat-card {
            flex: 1 0 20%;
            min-width: 200px;
            margin: 0 10px 20px;
        }

        .legend {
            margin-top: 20px;
        }

        .legend-item {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }

        .legend-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <h1>Tree of Life Visualization</h1>

    <div class="controls">
        <button id="zoomIn">Zoom In</button>
        <button id="zoomOut">Zoom Out</button>
        <button id="resetZoom">Reset View</button>

        <label style="margin-left: 15px;">
            <input type="checkbox" id="showLabels" checked> Show Labels
        </label>
    </div>

    <div id="status">Loading taxonomy data...</div>

    <div id="visualization"></div>

    <div class="stats-container">
        <div class="stat-card">
            <div class="card">
                <h5 class="card-title">Families</h5>
                <p class="card-text" id="familyCount">-</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="card">
                <h5 class="card-title">Genera</h5>
                <p class="card-text" id="genusCount">-</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="card">
                <h5 class="card-title">Species</h5>
                <p class="card-text" id="speciesCount">-</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="card">
                <h5 class="card-title">Largest Family</h5>
                <p class="card-text" id="largestFamily">-</p>
            </div>
        </div>
    </div>

    <div class="legend">
        <h4>Legend</h4>
        <div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #4682B4;"></span> Family
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #5F9EA0;"></span> Genus
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #82B446;"></span> Tree
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #B4824A;"></span> Palm Tree
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #746EB3;"></span> Shrub
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #999;"></span> Other
            </div>
        </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM elements
        const visualizationContainer = document.getElementById('visualization');
        const statusElement = document.getElementById('status');
        const zoomInButton = document.getElementById('zoomIn');
        const zoomOutButton = document.getElementById('zoomOut');
        const resetZoomButton = document.getElementById('resetZoom');
        const showLabelsCheckbox = document.getElementById('showLabels');

        // Count elements
        const familyCountElement = document.getElementById('familyCount');
        const genusCountElement = document.getElementById('genusCount');
        const speciesCountElement = document.getElementById('speciesCount');
        const largestFamilyElement = document.getElementById('largestFamily');

        // Initialize variables
        let svg;
        let g;
        let zoom;
        let hierarchyData;
        let root;

        // Create tooltip
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Set dimensions
        const width = visualizationContainer.clientWidth;
        const height = visualizationContainer.clientHeight || 800;
        const radius = Math.min(width, height) / 2 - 80;

        // Initialize SVG
        function initializeSvg() {
            // Create SVG
            svg = d3.select(visualizationContainer)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", [-width / 2, -height / 2, width, height])
                .style("font", "10px sans-serif");

            // Create a group for the tree
            g = svg.append("g");

            // Set up zoom behavior
            zoom = d3.zoom()
                .scaleExtent([0.1, 8])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });

            svg.call(zoom);
        }

        // Mock data for testing - this would be replaced with your actual fetch call
        function fetchData() {
            statusElement.textContent = "Loading taxonomy data...";

            // For testing purposes, create mock data
            // In your Django template, you'd use the actual fetch call to your API
            const mockData = {
                name: "Root",
                type: "root",
                children: [
                    {
                        name: "Pinaceae",
                        type: "family",
                        children: [
                            {
                                name: "Pinus",
                                type: "genus",
                                children: [
                                    {
                                        name: "Pinus strobus",
                                        type: "species",
                                        scientific_name: "Pinus strobus",
                                        life_form: "Tree",
                                        origin: "Native",
                                        iucn_status: "Least Concern"
                                    },
                                    {
                                        name: "Pinus resinosa",
                                        type: "species",
                                        scientific_name: "Pinus resinosa",
                                        life_form: "Tree",
                                        origin: "Native",
                                        iucn_status: "Least Concern"
                                    }
                                ]
                            },
                            {
                                name: "Abies",
                                type: "genus",
                                children: [
                                    {
                                        name: "Abies balsamea",
                                        type: "species",
                                        scientific_name: "Abies balsamea",
                                        life_form: "Tree",
                                        origin: "Native",
                                        iucn_status: "Least Concern"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        name: "Arecaceae",
                        type: "family",
                        children: [
                            {
                                name: "Phoenix",
                                type: "genus",
                                children: [
                                    {
                                        name: "Phoenix dactylifera",
                                        type: "species",
                                        scientific_name: "Phoenix dactylifera",
                                        life_form: "Palm Tree",
                                        origin: "Introduced",
                                        iucn_status: "Least Concern"
                                    }
                                ]
                            },
                            {
                                name: "Cocos",
                                type: "genus",
                                children: [
                                    {
                                        name: "Cocos nucifera",
                                        type: "species",
                                        scientific_name: "Cocos nucifera",
                                        life_form: "Palm Tree",
                                        origin: "Introduced",
                                        iucn_status: "Not Evaluated"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        name: "Rosaceae",
                        type: "family",
                        children: [
                            {
                                name: "Rosa",
                                type: "genus",
                                children: [
                                    {
                                        name: "Rosa canina",
                                        type: "species",
                                        scientific_name: "Rosa canina",
                                        life_form: "Shrub",
                                        origin: "Introduced",
                                        iucn_status: "Least Concern"
                                    },
                                    {
                                        name: "Rosa rugosa",
                                        type: "species",
                                        scientific_name: "Rosa rugosa",
                                        life_form: "Shrub",
                                        origin: "Introduced",
                                        iucn_status: "Least Concern"
                                    }
                                ]
                            },
                            {
                                name: "Malus",
                                type: "genus",
                                children: [
                                    {
                                        name: "Malus domestica",
                                        type: "species",
                                        scientific_name: "Malus domestica",
                                        life_form: "Tree",
                                        origin: "Introduced",
                                        iucn_status: "Not Evaluated"
                                    }
                                ]
                            },
                            {
                                name: "Prunus",
                                type: "genus",
                                children: [
                                    {
                                        name: "Prunus persica",
                                        type: "species",
                                        scientific_name: "Prunus persica",
                                        life_form: "Tree",
                                        origin: "Introduced",
                                        iucn_status: "Not Evaluated"
                                    },
                                    {
                                        name: "Prunus avium",
                                        type: "species",
                                        scientific_name: "Prunus avium",
                                        life_form: "Tree",
                                        origin: "Introduced",
                                        iucn_status: "Least Concern"
                                    }
                                ]
                            }
                        ]
                    }
                ]
            };

            // In Django template, replace this with code that processes the API response
            hierarchyData = mockData;
            updateStatistics();
            drawTree();
            statusElement.textContent = "Taxonomy data loaded successfully";

            // In your Django template, you'd use this fetch call:
            /*
            fetch('/api/v1/taxonomy/families/hierarchy/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Taxonomy data loaded successfully");
                    hierarchyData = data;
                    updateStatistics();
                    drawTree();
                    statusElement.textContent = "Taxonomy data loaded successfully";
                })
                .catch(error => {
                    console.error("Error fetching taxonomy data:", error);
                    statusElement.textContent = `Error loading data: ${error.message}`;
                });
            */
        }

        // Update statistics
        function updateStatistics() {
            if (!hierarchyData) return;

            // Count families
            const familyCount = hierarchyData.children?.length || 0;
            familyCountElement.textContent = familyCount;

            // Count genera
            let genusCount = 0;
            let speciesCount = 0;
            let largestFamily = '';
            let maxGenera = 0;

            hierarchyData.children?.forEach(family => {
                const genusCountForFamily = family.children?.length || 0;
                genusCount += genusCountForFamily;

                // Find largest family
                if (genusCountForFamily > maxGenera) {
                    maxGenera = genusCountForFamily;
                    largestFamily = family.name;
                }

                // Count species
                family.children?.forEach(genus => {
                    speciesCount += genus.children?.length || 0;
                });
            });

            genusCountElement.textContent = genusCount;
            speciesCountElement.textContent = speciesCount;
            largestFamilyElement.textContent = largestFamily || 'None';
        }

        // Draw tree
        function drawTree() {
            if (!hierarchyData || !svg || !g) return;

            // Clear existing content
            g.selectAll("*").remove();

            // Create hierarchy
            root = d3.hierarchy(hierarchyData);

            // Calculate the count of total descendants for each node
            root.count();

            // Create tree layout - radial layout
            const tree = d3.cluster()
                .size([2 * Math.PI, radius])
                .separation((a, b) => (a.parent == b.parent ? 1 : 2) / a.depth);

            // Apply tree layout
            tree(root);

            // Add links
            g.selectAll(".link")
                .data(root.links())
                .join("path")
                .attr("class", "link")
                .attr("d", d3.linkRadial()
                    .angle(d => d.x)
                    .radius(d => d.y));

            // Add nodes
            const nodes = g.selectAll(".node")
                .data(root.descendants())
                .join("g")
                .attr("class", d => `node ${d.children ? "node--internal" : "node--leaf"}`)
                .attr("transform", d => `translate(${radialPoint(d.x, d.y)})`)
                .on("mouseover", function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", 0.9);

                    let tooltipHtml = `<h4>${d.data.name}</h4>`;

                    if (d.data.type === "species") {
                        tooltipHtml += `<p><strong>Scientific Name:</strong> ${d.data.scientific_name || d.data.name}</p>`;
                        if (d.data.life_form) tooltipHtml += `<p><strong>Life Form:</strong> ${d.data.life_form}</p>`;
                        if (d.data.origin) tooltipHtml += `<p><strong>Origin:</strong> ${d.data.origin}</p>`;
                        if (d.data.iucn_status) tooltipHtml += `<p><strong>IUCN Status:</strong> ${d.data.iucn_status}</p>`;
                    } else {
                        tooltipHtml += `<p><strong>Type:</strong> ${d.data.type}</p>`;
                        tooltipHtml += `<p><strong>Children:</strong> ${d.children ? d.children.length : 0}</p>`;
                    }

                    tooltip.html(tooltipHtml)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add circles to nodes
            nodes.append("circle")
                .attr("r", d => getNodeRadius(d))
                .style("fill", d => getNodeColor(d))
                .style("stroke", d => d3.rgb(getNodeColor(d)).darker(0.5));

            // Add labels to nodes
            nodes.append("text")
                .attr("dy", ".31em")
                .attr("x", d => d.x < Math.PI ? 6 : -6)
                .attr("text-anchor", d => d.x < Math.PI ? "start" : "end")
                .attr("transform", d => `rotate(${(d.x < Math.PI ? d.x - Math.PI / 2 : d.x + Math.PI / 2) * 180 / Math.PI})`)
                .style("font-size", d => getNodeFontSize(d))
                .text(d => d.data.name)
                .style("opacity", showLabelsCheckbox.checked ? 1 : 0)
                .each(function(d) {
                    // Ellipsis for long names
                    const self = d3.select(this);
                    const textLength = self.node().getComputedTextLength();
                    const text = d.data.name;

                    if (textLength > 40) {
                        self.text(text.substring(0, 15) + "...");
                    }
                });

            // Center the view
            resetView();
        }

        // Helper function to convert polar to Cartesian coordinates
        function radialPoint(x, y) {
            return [(y = +y) * Math.cos(x -= Math.PI / 2), y * Math.sin(x)];
        }

        // Helper functions
        function getNodeRadius(d) {
            switch(d.data.type) {
                case 'family': return 8;
                case 'genus': return 6;
                default: return 4; // species
            }
        }

        function getNodeFontSize(d) {
            switch(d.data.type) {
                case 'family': return '14px';
                case 'genus': return '12px';
                default: return '10px'; // species
            }
        }

        function getNodeColor(d) {
            switch(d.data.type) {
                case 'family': return '#4682B4'; // Steel Blue
                case 'genus': return '#5F9EA0'; // Cadet Blue
                default: {
                    // For species, color based on life form if available
                    const lifeForm = d.data.life_form?.toLowerCase() || '';
                    if (lifeForm.includes('tree')) return '#82B446'; // Green
                    if (lifeForm.includes('palm')) return '#B4824A'; // Brown
                    if (lifeForm.includes('shrub')) return '#746EB3'; // Purple
                    return '#999'; // Default gray
                }
            }
        }

        // Control functions
        function zoomIn() {
            svg.transition().duration(300).call(
                zoom.scaleBy, 1.3
            );
        }

        function zoomOut() {
            svg.transition().duration(300).call(
                zoom.scaleBy, 0.7
            );
        }

        function resetView() {
            svg.transition().duration(500).call(
                zoom.transform,
                d3.zoomIdentity
            );
        }

        function toggleLabels() {
            const showLabels = showLabelsCheckbox.checked;
            g.selectAll(".node text").style("opacity", showLabels ? 1 : 0);
        }

        // Set up event listeners
        zoomInButton.addEventListener('click', zoomIn);
        zoomOutButton.addEventListener('click', zoomOut);
        resetZoomButton.addEventListener('click', resetView);
        showLabelsCheckbox.addEventListener('change', toggleLabels);

        // Initialize visualization
        initializeSvg();
        fetchData();

        // Handle window resize
        window.addEventListener('resize', function() {
            const newWidth = visualizationContainer.clientWidth;
            const newHeight = visualizationContainer.clientHeight || 800;
            const newRadius = Math.min(newWidth, newHeight) / 2 - 80;

            // Update SVG dimensions
            svg.attr("width", newWidth)
               .attr("height", newHeight)
               .attr("viewBox", [-newWidth / 2, -newHeight / 2, newWidth, newHeight]);

            // Redraw tree with new dimensions
            if (hierarchyData) {
                drawTree();
            }
        });
    });
    </script>
</body>
</html>
